
<!DOCTYPE html>
<html lang="pt" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head('CodeMy - Assistir VÃ­deo')}"></head>
<body style="background:var(--bg);color:var(--text);margin:0;">

  <header class="sticky" style="position:sticky;top:0;z-index:100;background:rgba(10,10,11,0.8);backdrop-filter:blur(16px);padding:16px 24px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;">
    <div class="brand" style="font-weight:900;font-size:24px;letter-spacing:-0.5px;">CODE<span style="background: linear-gradient(135deg, var(--brand) 0%, #C4B5FD 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">MY</span></div>
    <div style="display:flex;gap:12px;align-items:center">
      <a href="/web" class="btn ghost" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);padding:10px 14px;border-radius:10px;text-decoration:none;color:var(--text)">âŸµ Voltar</a>
      <a href="/auth-web" class="btn ghost" onclick="localStorage.removeItem('CodeMy_token')" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);padding:10px 14px;border-radius:10px;text-decoration:none;color:var(--text)">Sair</a>
    </div>
  </header>

  <main class="container" style="max-width:1280px;margin:24px auto;padding:0 24px;display:grid;gap:24px;grid-template-columns:1fr;">
    <section>
      <div class="video-wrap" style="position:relative;padding-top:56.25%;border-radius:16px;overflow:hidden;background:linear-gradient(135deg,#0f0f11 0%, #1a1a1e 100%);border:1px solid rgba(255,255,255,0.06)">
        <iframe id="player" src="" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen style="position:absolute;inset:0;width:100%;height:100%;border:0"></iframe>
      </div>

      <h1 id="titulo" class="title" style="font-size:28px;font-weight:800;margin:20px 0 8px"></h1>
      <p id="descricao" class="desc" style="color:var(--text-secondary);margin:0 0 16px 0"></p>

      <div class="actions" style="display:flex;gap:12px;align-items:center;margin-bottom:24px;flex-wrap:wrap;">
        <button id="favBtn" class="btn fav" style="background:linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);color:#fff;border:none;padding:10px 18px;border-radius:12px;cursor:pointer;font-weight:600;font-size:14px">Favoritar</button>
        <button id="copyBtn" class="btn ghost" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:var(--text);padding:10px 18px;border-radius:12px;cursor:pointer;font-weight:600;font-size:14px">Copiar link</button>
        <span id="chipNivel" class="chip" style="display:inline-block;background:linear-gradient(135deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.06) 100%);border:1px solid rgba(255,255,255,0.08);color:#a1a1aa;padding:6px 14px;border-radius:999px;font-size:12px;font-weight:500"></span>
      </div>

      <section class="panel elev comments" style="background:rgba(15,15,17,0.6);border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:16px;">
        <h2 style="margin:0 0 16px 0;font-size:18px;font-weight:700">ComentÃ¡rios</h2>
        <ul id="commentsList" class="c-list" style="list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:12px"></ul>
        <form id="commentForm" autocomplete="off" style="margin-top:12px">
          <textarea id="commentText" class="input" rows="3" maxlength="500" placeholder="Escreva um comentÃ¡rio..." style="width:100%;padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);background:rgba(20,20,23,0.6);color:var(--text);"></textarea>
          <div class="form-row" style="display:flex;gap:12px;align-items:center;justify-content:flex-end;margin-top:8px">
            <span id="charCount" class="char" style="font-size:12px;color:var(--muted);margin-right:auto;font-weight:500">0/500</span>
            <button type="submit" class="btn" style="background:linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);color:#fff;border:none;padding:10px 18px;border-radius:12px;cursor:pointer;font-weight:600;font-size:14px">Enviar comentÃ¡rio</button>
          </div>
        </form>
      </section>
    </section>

    <aside class="side" style="display:flex;flex-direction:column;gap:16px"></aside>
  </main>

  <footer th:replace="~{fragments/layout :: footer}"></footer>

  <script>
    const $ = sel => document.querySelector(sel);
    function escapeHtml(str){return (str||'').replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]))}
    function linkify(str){return (str||'').replace(/(https?:\/\/\S+)/g,'<a href="$1" target="_blank" rel="noopener">$1</a>')}
    function timeAgoFromIso(iso){const ts=Date.parse(iso);if(!ts)return'';const s=Math.floor((Date.now()-ts)/1000);if(s<60)return'agora';const m=Math.floor(s/60);if(m<60)return m+' min';const h=Math.floor(m/60);if(h<24)return h+' h';const d=Math.floor(h/24);return d+' d'}
    function toast(msg){const el=document.createElement('div'); el.style.cssText='position:fixed;left:50%;bottom:32px;transform:translateX(-50%);background:linear-gradient(135deg, #22D3A8 0%, #0ea5e9 100%);color:#fff;padding:10px 16px;border-radius:12px;font-weight:600;box-shadow:0 10px 30px rgba(34,211,168,0.4);z-index:9999;'; el.textContent=msg; document.body.appendChild(el); setTimeout(()=>{el.remove()},2000);}

    const params=new URLSearchParams(location.search);
    const videoId=params.get('id');
    const token=localStorage.getItem('CodeMy_token');
    const listEl = $('#commentsList');
    const form = $('#commentForm');
    const textInput = $('#commentText');
    const charCount = $('#charCount');
    const favBtn = $('#favBtn');
    const tituloEl = $('#titulo');
    const descEl = $('#descricao');
    const chipNivel = $('#chipNivel');
    const player = $('#player');

    function toEmbed(url){
      if(!url) return '';
      try{
        const u = new URL(url);
        if(u.hostname.includes('youtube.com')){
          const vid = u.searchParams.get('v');
          return vid ? `https://www.youtube.com/embed/${vid}` : '';
        }
        if(u.hostname.includes('youtu.be')){
          const seg = u.pathname.replace('/','');
          return seg ? `https://www.youtube.com/embed/${seg}` : '';
        }
        return url;
      }catch{ return url; }
    }

    async function loadVideo(){
      if(!videoId){ return; }
      const res = await fetch(`/api/v1/videos/${videoId}`);
      if(!res.ok){ tituloEl.textContent = 'VÃ­deo nÃ£o encontrado'; return; }
      const v = await res.json();
      tituloEl.textContent = v.titulo || 'Sem tÃ­tulo';
      chipNivel.textContent = v.nivelAcesso || '';
      player.src = toEmbed(v.url || '');
      // Exibe descriÃ§Ã£o do vÃ­deo
      descEl.textContent = v.descricao || '';
      return v;
    }

    charCount.textContent = '0/500';
    textInput.addEventListener('input', ()=> charCount.textContent = `${textInput.value.length}/500`);
    textInput.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){ form.requestSubmit(); }});

    async function loadComments(){
      if(!videoId){ listEl.innerHTML=''; return; }
      try{
        const res = await fetch(`/api/v1/videos/${videoId}/comentarios`);
        if(!res.ok){ listEl.innerHTML=''; return; }
        const data = await res.json();
        listEl.innerHTML = data.map(c=>`
          <li style="display:flex;gap:10px">
            <div style="flex:0 0 42px;height:42px;border-radius:50%;background:linear-gradient(135deg, var(--brand) 0%, #C4B5FD 100%);display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff">${escapeHtml((c.nomeUsuario||'V').charAt(0).toUpperCase())}</div>
            <div style="flex:1;background:rgba(20,20,23,0.6);border:1px solid rgba(255,255,255,0.06);border-radius:12px;padding:12px 14px">
              <div style="font-size:13px;color:var(--text-secondary);margin-bottom:6px"><strong style="color:var(--text)">${escapeHtml(c.nomeUsuario||'')}</strong> Â· <span>${timeAgoFromIso(c.criadoEm)}</span></div>
              <div style="color:var(--text)">${linkify(escapeHtml(c.texto||''))}</div>
            </div>
          </li>
        `).join('');
      }catch{ listEl.innerHTML=''; }
    }

    form.addEventListener('submit', async e=>{
      e.preventDefault();
      const txt = textInput.value.trim();
      if(!txt){ toast('Escreva algo antes de enviar'); return; }
      if(!token){ toast('FaÃ§a login para comentar'); return; }
      if(!videoId){ toast('VÃ­deo invÃ¡lido'); return; }
      try{
        const res = await fetch(`/api/v1/videos/${videoId}/comentarios`, {
          method:'POST',
          headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},
          body: JSON.stringify({texto: txt})
        });
        if(!res.ok){ const err=await res.json().catch(()=>({})); toast(err.detail||'Falha ao publicar'); return; }
        textInput.value=''; charCount.textContent='0/500';
        await loadComments();
        toast('ComentÃ¡rio publicado!');
      }catch{ toast('Erro de rede'); }
    });

    async function getFavState(){
      if(!token || !videoId) return false;
      try{
        const res=await fetch('/api/v1/favoritos',{headers:{'Authorization':`Bearer ${token}`}});
        if(!res.ok) return false;
        const favs=await res.json();
        const currTitle = tituloEl.textContent?.trim() || '';
        return Array.isArray(favs) && favs.some(f=> (f.tituloVideo||'').trim()===currTitle);
      }catch{return false}
    }
    function syncFavUI(state){ favBtn.classList.toggle('active', state); favBtn.textContent = state ? 'Favoritado' : 'Favoritar'; }

    favBtn.addEventListener('click', async ()=>{
      if(!token){ toast('FaÃ§a login para favoritar'); return; }
      if(!videoId){ toast('VÃ­deo invÃ¡lido'); return; }
      const atual = favBtn.classList.contains('active');
      try{
        const res = await fetch(`/api/v1/favoritos/${videoId}`, { method: atual? 'DELETE':'POST', headers:{ 'Authorization':`Bearer ${token}`}});
        if(!res.ok){ const err=await res.json().catch(()=>({})); toast(err.detail||'Falha ao atualizar favorito'); return; }
        syncFavUI(!atual);
        toast(!atual? 'Adicionado aos favoritos':'Removido dos favoritos');
      }catch{ toast('Erro de rede'); }
    });

    $('#copyBtn').addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(location.href); toast('Link copiado!'); }
      catch{ toast('NÃ£o foi possÃ­vel copiar'); }
    });

    (async ()=>{ await loadVideo(); syncFavUI(await getFavState()); await loadComments(); })();
  </script>
</body>
</html>

